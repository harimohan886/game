name: Update DevOps Metrics Dashboard
on:
  schedule:
    - cron: "0 */6 * * *"  # Every 6 hours
  workflow_dispatch:
  push:
    branches:
      - main
permissions:
  contents: write
jobs:
  generate-metrics:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Create assets directory
        run: mkdir -p assets metrics

      - name: Generate deployment metrics
        run: |
          cat > metrics/README.md << 'EOF'
          # DevOps Metrics Dashboard
          
          ## ðŸ“Š GitHub Stats
          ![GitHub Stats](https://github-readme-stats.vercel.app/api?username=${{ github.repository_owner }}&show_icons=true&theme=dark&include_all_commits=true)
          
          ## ðŸ”¥ Streak Stats
          ![GitHub Streak](https://github-readme-streak-stats.herokuapp.com/?user=${{ github.repository_owner }}&theme=dark)
          
          ## ðŸ“ˆ Activity Graph
          ![Activity Graph](https://github-readme-activity-graph.vercel.app/graph?username=${{ github.repository_owner }}&theme=github-dark)
          
          ## Pipeline Metrics
          - **Last Updated**: $(date '+%Y-%m-%d %H:%M:%S UTC')
          - **Deployments (Last 7 Days)**: $(git log --since='7 days ago' --grep='deploy\|release' --oneline 2>/dev/null | wc -l)
          - **Commits (Last 7 Days)**: $(git log --since='7 days ago' --oneline 2>/dev/null | wc -l)
          - **Total Workflow Runs**: ${{ github.run_number }}
          EOF

      - name: Generate workflow status badge
        run: |
          echo "[![Metrics Update](https://github.com/${{ github.repository }}/actions/workflows/metrics.yml/badge.svg)](https://github.com/${{ github.repository }}/actions/workflows/metrics.yml)" >> metrics/README.md

      - name: Check for Terraform files
        id: check-tf
        run: |
          if [ -n "$(find . -name '*.tf' -type f 2>/dev/null)" ]; then
            echo "has_terraform=true" >> $GITHUB_OUTPUT
          else
            echo "has_terraform=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate Terraform docs
        if: steps.check-tf.outputs.has_terraform == 'true'
        uses: terraform-docs/gh-actions@v1.0.0
        with:
          working-dir: .
          output-file: assets/infrastructure.md
          
      - name: Commit updated metrics
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git diff --quiet && git diff --staged --quiet || (git commit -m "chore: update DevOps metrics [skip ci]" && git push)
